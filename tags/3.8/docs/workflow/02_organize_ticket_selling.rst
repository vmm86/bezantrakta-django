####################################
Организация продажи билетов на сайте
####################################

Продажа билетов (как и онлайн-оплата) осуществляется специально разработанными для этих целей сторонними сервисами.

**Сервисы продажи билетов (СПБ)**
  Сторонние сервисы, предназначенные для **продажи билетов** на различные мероприятия (концерты, спектакли и т.п.).

На данный момент платформа поддерживает работу с двумя видами СПБ:

* :deleted:`СуперГовно` **СуперБилет**
* **Радарио**

**Сервисы онлайн-оплаты (СОО)**
  Сторонние сервисы, предназначенные для **онлайн-оплаты** (оплата заказа в процессе его оформления, как правило, с помощью банковских карт).

На данный момент платформа поддерживает работу с двумя видами СОО:

* **Сбербанк**
* **СургутНефтеГазБанк** (СНГБ)

.. attention:: Рекомендуется **заранее озаботиться созданием аккаунта в СОО** для нового сайта, чтобы при его создании уже иметь учётные данные для подключения онлайн-оплаты.

********************
Привязка СПБ к сайту
********************

Размещать события в конкретном СПБ можно по-разному. В конкретном СПБ могут храниться события, которые нужно размещать:

* либо **на одном сайте**,

  Если администратор создал новый сайт, на котором должен работать какой-то конкретный СПБ, ему необходимо создать в админ-панели новый СПБ в привязке к этому сайту.

* либо **на разных сайтах** (своего рода shared-СПБ).

  Если администратору нужно создать несколько сайтов, которые **будут получать разные события из одного и того же СПБ**, ему необходимо создать в админ-панели несколько СПБ в привязке к каждому из сайтов, настройки подключения к которым будут одинаковыми, а JSON-настройки для получения информации из СПБ будут разными. Подробности настройки будут рассмотрены далее.

  .. only:: dev

    Таким shared-СПБ на данный момент явялется изначально только воронежский СуперБилет, в котором также хранится информация дял всех "новых" сайтов.

Сначала в разделе :doc:`/third_party/ticket_service/admin/ticket_service` необходимо создать один или несколько СПБ, привязанных к созданному сайту, чтобы затем получать оттуда события для продажи. К одному сайту можно подключать несколько СПБ.

* Название: ``Сервис продажи билетов (Сайт)``
* Идентификатор: псевдоним СПБ плюс псевдоним сайта в латиннинце
* Сервис продажи билетов: выбрать из имеющихся вариантов
* ✔ Работает (если СПБ отключен - он не участвует в последующем импорте информации на сайт)
* Сайт: выбрать сайт, к которому нужно привязать СПБ
* Сервис онлайн-оплаты: выбрать созданный ранее СОО, который нужно привязать к этому СПБ или оставить поле пустым
* Отредактировать созданные по умолчанию **JSON-настройки СПБ**, необходимые для его работы на конкретном сайте:

  * ``init``: настройки подключения к стороннему СПБ, по умолчанию - к воронежскому shared-СуперБилету. При работе с другими СПБ настройки подключения нужно будет изменить.

  * ``schemes``: список ID схем залов, которые нужно будет импортировать из СПБ, по умолчанию - пустой список.

    .. attention:: В зависимости от того, к какому из 2-х указанных типов принадлежит конкретный СПБ, его настройка проходит по-разному:

      * Если **все события стороннего СПБ нужно размещать на одном сайте**, то в админ-панели создаётся этот СПБ в привязке к этому сайту, и параметр ``schemes`` в JSON-настройках СПБ остаётся пустым. Это позволяет при запусках задания на импорт получать из этого СПБ **все его схемы залов и все его события** для публикации на этом сайте.

      * Если **сторонний shared-СПБ содержит события, предназначенные для размещения на разных сайтах** (например, воронежский СуперБилет, который содержит события всех новых сайтов в новых городах), то для каждого из этих сайтов, включая Воронеж, в админ-панели создаются отдельные СПБ **с одинаковыми настройками подключения** (параметр ``init``), но **с разными настройками импорта** событий из схем залов (параметр ``schemes``). В каждом из этих СПБ в параметре ``schemes`` в списке перечисляются **именно те схемы залов, которые нужно импортировать на конкретный сайт**, к которому привязан этот конкретный СПБ. Это позволяет при запусках задания на импорт каждому сайту получать из одного стороннего СПБ **только предназначенные для этого сайта схемы залов и события**, а не вообще всё, что в нём размещено.

  * ``order``: включение/отключение способов заказа билетов на всём сайте, по умолчанию - все включены.

    Для новых сайтов на данный момент времени следует включать только последний тип ``email_online`` (электронные билеты на email с онлайн-оплатой).

  * ``order_description``: текстовые описания способов заказа билетов на шаге 2 заказа билетов, по умолчанию - пустые.

    Нужно заполнить, если для конкретного типа заказа билетов важна какая-то сопроводительная информация (например, срок брони на билеты или в конкретной кассе НЕ выдаются билеты, оплаченные онлайн с получением в кассе и т.п.).

  * ``order_email``: email-аккаунт для отправки email-уведомлений, по умолчанию - shared-email для новых сайтов.

  * ``order_description_email``: текстовые описания способов заказа билетов в email-уведомлениях покупаетлю, по умолчанию - пустые.

    Нужно заполнить, если для конкретного типа заказа билетов важна какая-то сопроводительная информация (например, , срок брони на билеты или в конкретной кассе НЕ выдаются билеты, оплаченные онлайн с получением в кассе и т.п.).

  * ``max_seats_per_order``: максимальное число билетов в одном заказе, по умолчанию - ``7``.

  * ``courier_price``: стоимость доставки курьером в рублях, по умолчанию - ``0`` (если ``0`` - доставка бесплатная).

  * ``promoter``: реквизиты организатора событий (промоутера), по умолчанию - ``ООО «БЕЛЬКАНТО» ИНН 3662243480``.

    Указывается в электронных PDF-билетах, если это поле в JSON-настройках события пустое.

  * ``seller``: реквизиты продаца билетов (агента), по умолчанию - ``ИП Карюков Игорь Леонидович ИНН 366202613092 ОГРНИП 313366803500228``.

    Указывается в электронных PDF-билетах, если это поле в JSON-настройках события пустое.

.. only:: dev

  Значения по умолчанию хранятся в модуле ``third_party.ticket_service.settings``.

********************
Привязка СОО к сайту
********************

Если в событиях на сайте предполагается использовать онлайн-оплату, в разделе :doc:`/third_party/payment_service/admin/payment_service` необходимо создать новый СОО. К одному СПБ можно подключить один СОО.

* Название: ``Сервис онлайн-оплаты (Сайт)``
* Идентификатор: псевдоним СОО плюс псевдоним сайта в латиннинце
* Сервис онлайн-оплаты: выбрать из имеющихся вариантов
* ✔ Работает
* ✔ Оплата настоящими деньгами

  * Если включено - оплата настоящими деньгами,
  * Если отключено - тестовая оплата НЕнастоящими деньгами.

  .. only:: dev

    .. todo:: Этот параметр для удобства работы можно перевести в JSON-настройки СОО в булев-параметр ``test``.

* Отредактировать созданные по умолчанию **JSON-настройки СОО**, необходимые для работы онлайн-оплат на конкретном сайте:

  * ``init``: настройки подключения к стороннему СОО, по умолчанию - пустые.
  * ``commission``: процент комиссии СОО, добавляемый к общей стоимости заказа при онлайн-оплате. Дробное число указывается через точку, например, ``2.8``. Если комиссия равна ``0`` - она НЕ прибавляется к сумме заказа.
  * ``timeout`` - время в минутах на проведение оплаты покупателем после её создания (по умолчанию - ``15``).

************************
Импорт информации из СПБ
************************

После привязки к сайту одного или нескольких СПБ из них на сайт начинает импортироваться информация, необходимая для организации продажи билетов на сайте. Запуск задания ``ts_discover`` происходит **раз в 15 минут** (в ``0``-ю, ``15``-ю, ``30``-ю и ``45``-ю минуту каждого часа).

Импорт информации из СПБ проходит в 2 этапа:

1. Сначала на сайт из подключенного к нему СПБ импортируются :doc:`схемы залов </third_party/ticket_service/admin/ticket_service_scheme_venue_binder>`, в которых размещены события для продажи билетов. Для того, чтобы из этих схем можно было импортировать сами события, эти схемы залов нужно привязать к :doc:`залам </bezantrakta/event/admin/event_venue>`, к которым они относятся. Если зал для какой-то новой схемы ещё не создан - его нужно создать в разделе :doc:`/bezantrakta/event/admin/event_venue`.

  **Схема зала**
    Упрощённая схема расположения мест в зрительном зале, которая отображается на сайте на странице события (шаг 1 закза билетов), чтобы пользователь мог выбрать на ней необходимые билеты и сделать заказ.

  **Зал**
    Конкретное место проведения событий (здание или открытия площадка), к которому из каждого из подключенных к сайту СПБ может быть привязано несколько схем залов (разные помещения в одном зале или разные конфигурации одного и того же помещения в одном зале).

  Такая взаимосвязь залов и схем залов предусмотрена для того, чтобы иметь возможность **показать на сайте в рамках одного зала события, импортированные из разных СПБ**. Например, и в ``СуперБилет (Воронеж)``, и в ``Радарио (Камерный театр)`` (которые привязаны к главному воронежскому сайту) есть схемы залов, относящиеся к воронежскому Камерному театру. В них время от времени могут появляться новые события. Чтобы эти события на сайте относились к одному залу и их можно было показать на одной странице при фильтрации событий по залу (по ссылке ``/afisha/venue/chambervrn``), эти схемы залов привязываются к одному залу "Камерный театр", созданному в разделе :doc:`/bezantrakta/event/admin/event_venue`.

  .. note:: При импорте информации из СПБ *схемы залов изначально создаются пустыми*. Чтобы показать свободные для продажи места в событии на сайте, схему зала нужно нарисовать. Для этого предназначена специальная панель с кнопками в HTML-редакторе схем залов/секторов в админ-панели сайта. Подробнее смотрите раздел :doc:`схемы залов </third_party/ticket_service/admin/ticket_service_scheme_venue_binder>`, пункт "**Отрисовка схем залов**".

  .. only:: dev

    Во внутреннем API проекта у дочерних классов СПБ, как правило, реализован метод ``scheme`` для получения информации о содержимом конкретной схемы зала. Но формат вывода не унифицирован и у разных СПБ будет разным и, возможно, НЕчеловекопонятным. Теоретически можно попытаться разбирать этот вывод и создавать в схемах зала при импорте если не готовую табличную схему, то по крайней мере список с информацией о каждом месте для последующей отрисовки.

  .. important:: **Переход на 2-й этап импорта из конкретной схемы зала произойдёт только после её привязки к родительскому залу!** Это нужно делать в процессе эксплутатции для новых схем залов, создаваемых в конкретном СПБ уже после его подключения к сайту.

2. После привязки какой-либо схемы зала к её родительскому залу при следующих импортах информации на сайт **из этих схем залов будут добавлены события** для продажи билетов. Некоторые события, имеющие между собой что-то общее, могут быть связаны в **группы**.

При правильно организованном импорте новые события, предназначенные для публикации на сайте, из привязанного к конкретному сайту СПБ будут добавлены в раздел :doc:`/bezantrakta/event/admin/event`. После этого для открытия продаж билетов администратору нужно **опубликовать на конкретном сайте те ли иные события**.

*********************************
Публикация событий/групп на сайте
*********************************

Для того, чтобы пользователь мог заказать билеты в каком-либо событии, это **событие должно быть опубликовано на сайте** и пользователь должен иметь возможность **открыть страницу события при переходе с афиши** самого события или группы, в которую оно входит.

**Событие**
  Какое-либо мероприятие (концерт, спектакль и проч.), билеты на которое должны быть размещены в продаже на сайте на странице соотв. события.

**Группа**
  Объединение нескольких событий, имеющих между собой что-то общее:

  * несколько концертов одного исполнителя в одном зале в разные дни,
  * один концерт одного исполнителя в разных схемах одного и того же зала (большой зал в СПБ м.б. разбит на две или более отдельные схемы),
  * повторяющиеся театральные спектакли,
  * повторяющиеся события в рамках одного абонемента и т.п.

Чтобы опубликовать на сайте событие или группу, нужно:

* Открыть конкретное событие или группу в разделе :doc:`/bezantrakta/event/admin/event`,
* При необходимости изменить/заполнить название, метатеги, описание в HTML-редакторе.
* ✔ **Публикация**

  * Если включено БЕЗ привязки афиш - событие можно открыть только по прямой ссылке.
  * Если включено С привязкой афиш - событие можно открыть при клиен на афишу или по прямой ссылке.
  * Если отключено - событие нельзя открыть даже по прямой ссылке.

* ✔ **На главной** (только для маленьких вертикальных афиш)

  * Если включено С привязкой маленьких вертикальных афиш - эти афиши выводятся сразу же на главной странице.
  * Если включено БЕЗ привязки маленьких вертикальных афиш или отключено - не играет роли в показе афиш на сайте. Афиши в других "больших" контейнерах в любом случае показываются в основном шаблоне сайте и не зависят от этой опции.

* **Минимальная цена билета** импортируется из СПБ и обновляется автоматически при её изменении (если все билеты на самую дешёвую цену уже раскупили)

* **Дата/время** импортируется из СПБ и обновляется автоматически при её изменении (при переносе мероприятия)

  * для события - дата/время самого этого события,
  * для группы - дата/время самого раннего актуального события в группе на данный момент.

* Возрастное ограничение: выбор из нескольких вариантов.

* Категория: выбор из нескольких вариантов. Новые категории можно создавать в разделе :doc:`/bezantrakta/event/admin/event_category`.

* Зал указывается при импорте из СПБ, учитывая, к какому залу была привязана схема зала, к которой, в свою очередь, принадлежит конкретное событие. Если событие привязывается к другой схеме зала, принадлежащей другому залу - эта информация автоматически обновится при следующем импорте.

* Сайт указывается при импорте из СПБ, учитывая, к какому сайту был привязан конкретный СПБ.

* Группа: явялется ли эта запись событием ✔️ или группой ❌.

* Сервис продажи билетов (СПБ) указывается при импорте.

* ID события или группы в СПБ указывается при импорте.

* ID схемы зала в СПБ указывается при импорте только для событий. Если событие привязывается к другой схеме зала, принадлежащей другому залу - эта информация автоматически обновится при следующем импорте.

* Поля с реквизитами **организатора** (промоутера) и **агента** (продавца билетов) указываются при импорте только для событий и м.б. отредактированы при необходимости. Если эти поля в событии пустые - вместо них используются значения таких же полей в JSON-настройках СПБ.

* По необходимости отредактировать созданные по умолчанию **JSON-настройки** события/группы:

  * ``order`` - включение/выключение способов заказа билетов в событии, по умолчанию - всё включено.

    * Если какой-то способ заказа билетов **включен в настройках СПБ и отключен в событии** - он НЕ отображается на шаге 2 заказа билетов для этого события.
    * Если какой-то способ заказа билетов **отключен в настройках СПБ и включен в событии** - он в любом случае НЕ будет отображаться на шаге 2 заказа билетов для любого события из этого СПБ.

  * ``extra`` - **сервисный сбор** в процентах от цены каждого билета в событии, по умолчанию - ``0``.

    * Если сервисный сбор равен ``0`` - он НЕ используется.
    * Если сервисный сбор больше ``0``, то при вычислении общей суммы заказа к ней сверху будет добавлен указанный процент от цены каждого из билетов в заказе.

  * ``title`` - произвольный текст поверх афиши, например, подпись события в группе ("Партер", "Секторы", "Танцпол" и т.п.) или название города в конкретном событии, если он отличается от города сайта в целом ("Рамонь" или "Лиски" на воронежском сайте).

  * ``cancelled`` - текст "**Отмена**" поверх афиши, если событие отменено.

  * ``rescheduled`` - текст "**Перенос**" поверх афиши, если событие перенесено.

  * ``redirect`` - относительный адрес страницы события, на которую нужно перенаправлять пользователей, заходящих на страницу этого события, если это событие было перенесено (например, ``/afisha/2018/05/16/19-00/shou-improvizatsiya-158/``). Перенаправление требуется, как правило, в случае переноса мероприятия.

  * ``test`` - этот параметр со значением ``true`` обозначает **тестовые события**, афиши которых в любом случае НЕ показываются на сайте (только в тестовой версии для разработчиков). На страницы тестовых событий на сайте можно заходить напрямую из админ-панели, нажимая на кнопку "Смотреть на сайте".

Группы и события
================

На сайте можно разместить:

* либо **афишу отдельного события**, не привязанного к группе,
* либо **афишу группы**, содержащей несколько актуальных событий.

Чтобы **разместить на сайте афишу отдельного события**, нужно:

* :doc:`Открыть конкретное событие </bezantrakta/event/admin/event>`,
* Отредактировать событие, как указано выше,
* Разместить афиши в нужных контейнерах,
* Сохранить изменения в событии.

Чтобы **разместить на сайте афишу группы**, нужно:

* :doc:`Открыть конкретную группу </bezantrakta/event/admin/event>`,
* Отредактировать группу, как указано выше,
* Разместить афиши в нужных контейнерах,
* Сохранить изменения в группе.
* Затем пакетно опубликовать все актуальные на данный момент события в этой группе с помощью действия с выделенными объектами "**Опубликовать или снять с публикации**".

.. tip:: Если в группу входят время от времени повторяющиеся события (наприер, театральные спектакли или события в рамках одного абонемента), публикация на сайте самой группы, а не отдельных событий в ней серьёзно сокращает время работы администратора и делает её удобнее.

Независимо от того, на какую афишу в браузере нажмёт пользователь (афишу события или афишу группы), **в любом случае откроется страница события**. В случае группы откроется самое раннее актуальное событие в этой группе с возможностью навигации между событиями в группе, если их больше одного (в блоке "**Билеты на другую дату**"). Если у событий, привязанных к группе, нет специальных подписей, будtт отображаться их дата/время. [image]

Привязка событий к группе
=========================

.. attention:: **Событие в текущей реализации проекта можно привязать только к одной группе!** Если привязка ошибочна - она удаляется, и событие привязывают к нужной группе снова.

К группе, как правило, не требуется привязывать события вручную - привязка событий к группам происходит автоматически при их импорте из СПБ, но такая возможность существует - в блоке "**Привязка событий к группе**" можно как увидеть актуальные события в группе на данный момент, так и привязать к группе другие события или удалить из неё имеющиеся события, если это необходимо.

Чтобы вручную привязать событие к группе, нужно:

* Открыть группу в разделе :doc:`/bezantrakta/event/admin/event`,
* В блоке "**Привязка событий к группе**":

  * **[ + ] Добавить еще Привязка событий к группе**;
  * Выбрать событие из выпадающего списка "**Событие**";

    Привязанные к группам события не видны в этом выпадающем списке во избежание ошибок.

  * Указать подпись события в группе, если это необходимо;

    * Если подпись пустая - события в группе будут подписываться **датой/временем события**
    * Если подпись заполенна - события в группе будут подписываться **текстом этой подписи** ("Партер", "Секторы", "Танцпол" и т.п.)

  * Сохранить изменения.

Привязка внешних ссылок к событиям
==================================

**Внешние ссылки в событиях**
  Ссылки на страницы других сторонних сайтов, на которых проходит продажа билетов на это конкретное событие.

При необходимости в событии можно размещать **внешние ссылки** на другие сайты, продающие билеты на это событие. Внешние ссылки можно добавить как в событие, созданное вручную, так и в событие, импортированное из СПБ.

Чтобы добавить внешние ссылки в событии, нужно:

* Открыть событие в разделе :doc:`/bezantrakta/event/admin/event`,
* В блоке "**Привязка внешних ссылок к событиям**":

  * **[ + ] Добавить еще Привязка внешних ссылок к событиям**
  * Выбрать сторонний сайт продаж из выпадающего списка "**Ссылка**",
  * Указать адрес внешней ссылки, начинающийся с ``http://`` или ``https://``
  * Указать порядок следования ссылок, если их много,
  * Сохранить изменения.

Если на данный момент в админ-панели не добавлен необходимый сторонний сайт продаж, на который нужн осделать ссылку, его можно добавить в разделе :doc:`/bezantrakta/event/admin/event_link`, загрузив логотип этого сайта.

Привязанные к событию внешние ссылки будут отображаться в блоке "**Билеты**" в виде изображений с логотипами сторонних сайтов, обёрнутых в ссылку.

Привязка афиш группы/события к контейнерам
==========================================

Афиши того или иного размера могут быть размещены в одном или нескольких **контейнерах афиш**:

+-----------------------------------------+--------------------------+--------------+------------------------------------------------+
| Название контейнера                     | Тип контейнера           | Размер афиши | Положение                                      |
+=========================================+==========================+==============+================================================+
| **Большие вертикальные (слева)**        | Большие вертикальные     | 312x540 px   | Слева от содержимого сайта на широких экранах  |
+-----------------------------------------+--------------------------+--------------+------------------------------------------------+
| **Большие вертикальные (справа)**       | Большие вертикальные     | 312x540 px   | Справа от содержимого сайта на широких экранах |
+-----------------------------------------+--------------------------+--------------+------------------------------------------------+
| **Большие горизонтальные ("карусель")** | Большие горизонтальные   | 822x425 px   | Под текстовым поиском, справа от верхнего меню |
+-----------------------------------------+--------------------------+--------------+------------------------------------------------+
| **Маленькие вертикальные (VIP)**        | Маленькие вертикальные   | 213x255 px   | Внутри страницы (блок "**Рекомендуем**")       |
+-----------------------------------------+--------------------------+--------------+------------------------------------------------+
| **Маленькие вертикальные**              | Маленькие вертикальные   | 213x255 px   | Внутри страницы (обычный блок)                 |
+-----------------------------------------+--------------------------+--------------+------------------------------------------------+

.. note:: Новые контейнеры афиш при необходимости можно создавать в разделе :doc:`/bezantrakta/event/admin/event_container`, но без включения их вывода в шаблоне афиши в этих контейнерах не будут выводиться на сайте.

Чтобы указать в событии/группе афиши в разных контейнерах, нужно:

* Открыть событие/группу в разделе :doc:`/bezantrakta/event/admin/event`,
* В блоке "**Привязка афиш группы/события к контейнерам**":

  * **[ + ] Добавить еще Привязка афиш группы/события к контейнерам**;
  * Порядковые номера афиш в контейнере по умолчанию равны ``1`` и их можно не изменять без необходимости, т.к. при их равенстве у разных афиш они **сортируются по дате/времени события**;
  * Выбрать контейнер, в котором нужно разместить афишу;
  * Загрузить изображение афиши соотв. размера для выбранного контейнера;
  * Сохранить изменения.

  .. attention:: В любом случае при публикации события или группы на сайте **следует добавлять маленькую вертикальную афишу**, т.к. эти афиши используются не только для показа событий в заданных позициях, но и при фильтрации событий по какому-либо основанию (по дате в календаре, по категории сбоытий, по залу или в текстовом поиске), а также для генерации электронных PDF-билетов. При отсутствии такой афиши будет выводиться картинка-заглушка с логотипом Безантракта.
