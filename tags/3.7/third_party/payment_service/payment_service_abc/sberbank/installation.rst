#############################################
Установка и поддержка онлайн-оплаты Сбербанка
#############################################

*********************
Контакты техподдержки
*********************

* support@ecom.sberbank.ru
* `(800) 707-71-47 <tel:+78007077147>`_

*******************
Процесс подключения
*******************

Для работы с API онлайн-эквайринга Сбербанка и открытия формы оплаты непосредственно в процессе оформления заказа, используется **оплата по статическим ссылкам** (но не выставление счёта на email).

Реквизиты для онлайн-оплаты:
* Логин API - <мерчант>-api
* Логин ЛК (личный кабинет) - <мерчант>-operator

- Получение логинов и паролей для **тестовой оплаты**.

  * запросы к API: https://3dsec.sberbank.ru/payment/rest/
  * личный кабинет: https://3dsec.sberbank.ru/mportal-uat/index.html
  * мерчант
  * логин и пароль к API
  * логин и пароль оператора личного кабинета
  * пример страницы оплаты: https://3dsec.sberbank.ru/payment/merchants/bezantrakta/payment_ru.html
  * пример страницы ошибок: https://3dsec.sberbank.ru/payment/merchants/bezantrakta/errors_ru.html

- Тестирование работоспособности платежной страницы:

  * с использованием REST-интерфейса
  * с использованием формы для регистрации заказа
  * с использованием личного кабинета и консоли

- По готовности связаться со службой сопровождения rbssupport@bpc.ru для проверки сайта.
- Получение логинов и паролей для **production-оплаты**.

  * запросы к API: https://securepayments.sberbank.ru/payment/rest/
  * личный кабинет: https://securepayments.sberbank.ru/mportal/
  * мерчант
  * логин и пароль к API
  * логин и пароль оператора личного кабинета

- Переключение сайта на использование production-оплаты.
- Проведение тестовой оплаты настоящими деньгами с банковской карты (рекомендуется провести оплату по 3DS-карте, а также выполнить SSL-платеж).
- Отмена и/или возврат платежа в личном кабинете.
- Подписание акта о готовности Интернет-магазина.

Для доступа к системе необходимо иметь открытый исходящий доступ на адреса ``95.128.178.93`` (тестовый сервер) и ``62.76.205.3`` (production-сервер) по порту ``443``. Сервер сайта должен поддерживать протокол **TLS 1.2**.

При заключении договора клиент получает **логин** ``userName`` и **пароль** ``password``, которые нужно отправлять в любом запросе к REST API Сбербанка. Тестировать REST-запросы и работать в личном кабинете рекомендуют в разных браузерах.

Запросы к платёжному шлюзу синхронные и однонаправленные (только с сайта к шлюзу, а не наоборот).

Спецсимволы в значениях GET-параметров URL должны экранироваться перед отправкой.

После подтверждения заказа и успешного создания новой онлайн-оплаты покупатель перенаправляется на форму оплаты на сайте платёжного шлюза Сбербанка. Эта страница оформляется по умолчанию, но теоретически может быть свёрстана в стилистике самого сайта.

Таймаут на оплату по умолчанию - ``20`` минут (лучше ``15`` минут для унификации), по его истечении произойдёт отмена онлайн-оплаты.

**************
Тестовые карты
**************

В ``Cardholder name`` нужно указывать 2 или более слова в английской раскладке.

Для всех карт с *3D Secure* (``veres=y pares=y`` или ``veres=y pares=a``) пароль на ACS ``12345678``.

Тестирование успешной оплаты
============================

+-----------------------+-----------+------+-----------------+
| PAN                   | Exp. date | CVV2 | 3DSecure        |
+=======================+===========+======+=================+
| 4111 1111 1111 1111   | 2019/12   | 123  | veres=y pares=y |
| 6011 0000 0000 0004   | 2019/12   | 123  | veres=Y pares=A |
| 5555 5555 5555 5599   | 2019/12   | 123  | veres=n         |
| 6390 0200 0000 000003 | 2019/12   | 123  | veres=y pares=a |
+-----------------------+-----------+------+-----------------+

У последней карты *CVV2* - необязательный параметр.

Тестирование НЕуспешной оплаты
==============================

+-----------------------+-----------+------+-----------------+---------------------------------+
| PAN                   |  ExpDate  | CVV2 | 3DSecure        |  Error                          |
+=======================+===========+======+=================+=================================+
| Обычные карты                                                                                |
+-----------------------+-----------+------+-----------------+---------------------------------+
| 5555 5555 5555 5557   | 2019/12   | 123  | veres=y pares=u | PaRes status is U (-2011)       |
| 4000 0000 0000 0002   | 2019/12   | 123  | veres=u         | VeRes status is U (-2016)       |
| 4444 3333 2222 1111   | 2019/12   | 123  | veres=y pares=u | PaRes status is U (-2011)       |
| 5555 5555 4444 4442   | 2019/12   | 123  | veres=u         | VeRes status is U (-2016)       |
| 4444 4444 4444 4422   | 2019/12   | 123  |                 | Invalid message format (913)    |
| 4444 4444 1111 1111   | 2019/12   | 123  |                 | Network refused transaction (5) |
| 4444 4444 4444 6666   | 2019/12   | 123  |                 | BLOCKED_BY_LIMIT (-20010)       |
| 4444 4444 4444 4455   | 2019/12   | 123  |                 | Card limitations exceeded (902) |
| 4444 4444 9999 9999   | 2019/12   | 123  |                 | TDSEC_COMM_ERROR (151017)       |
| 4444 4444 4444 3333   | 2019/12   | 123  |                 | Limit exceeded (123)            |
| 4408 8962 5320 5448   | 2019/12   | 123  |                 | Not enough money (116)          |
| 4012 8888 8888 1881   | 2019/12   | 123  |                 | RESPONSE_TIMEOUT (151019)       |
| 4563 9601 2200 1999   | 2019/12   | 123  |                 | CANNOT_SEND_REQUEST (151018)    |
+-----------------------+-----------+------+-----------------+---------------------------------+
| Карты с баллами "СПАСИБО"                                                                    |
+-----------------------+-----------+------+-----------------+---------------------------------+
| 4276 0100 1329 6064   | 2017/12   | 555  | veres=n         | SPASIBO AMOUNT = true           |
| 4276 0100 1386 6254   | 2017/12   | 272  | veres=n         | SPASIBO AMOUNT = disabled       |
| 4276 0100 1966 3648   | 2017/12   | 774  | veres=n         | Activity, FRAUD = true          |
+-----------------------+-----------+------+-----------------+---------------------------------+
