from project.shortcuts import build_absolute_url


def success_or_error(basket, payment_status):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∏–ª–∏ –ù–ï—É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã.

    Args:
        basket (bezantrakta.order.order_basket.OrderBasket): –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–∫–∞–∑–æ–º.
        payment_status (dict): –°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç—ã.

    Returns:
        dict: –°–ª–æ–≤–∞—Ä—å ``result`` —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—Å–ø–µ—à–Ω–æ–º –∏–ª–∏ –ù–ï—É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ —Å –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–æ–π.
            –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
                * **success** (bool): –£—Å–ø–µ—à–Ω–æ–µ (``True``) –∏–ª–∏ –ù–ï—É—Å–ø–µ—à–Ω–æ–µ (``False``) –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞.
                * **messages** (list): –°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. –í —Å–ª—É—á–∞–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ - –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫, –≤ —Å–ª—É—á–∞–µ –ù–ï—É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ - —Å–ø–∏—Å–æ–∫ –∏–∑ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∫–ª—é—á–∞–º–∏ ``level`` (—É—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–∫–∏) –∏ ``message`` (—Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ).
    """
    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
    result = {}
    result['success'] = None
    result['messages'] = []

    # –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —É—Å–ø–µ—à–Ω–æ
    if payment_status['success']:
        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –≤ —Å–µ—Ä–≤–∏—Å–µ –ø—Ä–æ–¥–∞–∂–∏ –±–∏–ª–µ—Ç–æ–≤
        order_approve = basket.order_approve()

        basket.logger.info('\nbasket.order payment approved: {}'.format(basket.order))

        # –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –≤ —Å–µ—Ä–≤–∏—Å–µ –ø—Ä–æ–¥–∞–∂–∏ –±–∏–ª–µ—Ç–æ–≤
        if order_approve['success']:
            result['success'] = True

            # –û—Ç–ø—Ä–∞–≤–∫–∞ email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é
            basket.email_admin()
            basket.email_customer()
        # –ó–∞–∫–∞–∑ –ù–ï —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –≤ —Å–µ—Ä–≤–∏—Å–µ –ø—Ä–æ–¥–∞–∂–∏ –±–∏–ª–µ—Ç–æ–≤
        else:
            result['success'] = False

            # –°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏–ª–∏ –≤ –ª–æ–≥-—Ñ–∞–π–ª–µ
            messages = [
                {
                    'level': 'error',
                    'message': '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–∞—à –∑–∞–∫–∞–∑ {order_id} –Ω–µ —Å–º–æ–≥ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —É—Å–ø–µ—à–Ω–æ. üôÅ'.format(
                        order_id=basket.order['order_id']
                    )
                },
                {
                    'level': 'info',
                    'message': '–ó–∞–∫–∞–∑ –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤–∞–º–∏ email.'
                },
                {
                    'level': 'info',
                    'message': '–ï—Å–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–µ –ø–æ—Å–ª–µ–¥—É–µ—Ç - <a href="{contacts_url}" target="_blank">—Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Å–∞–π—Ç–∞</a>.'.format(
                        contacts_url=build_absolute_url(basket.domain_slug, '/kontakty/')
                    )
                },
                {
                    'level': 'info',
                    'message': 'üëâ <a href="/">–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>.'.format(
                        event_url=basket.event['url']
                    )
                },
            ]

            for msg in messages:
                result['messages'].append(msg)

        return result
    # –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –ù–ï—É—Å–ø–µ—à–Ω–æ
    else:
        result['success'] = False

        # –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞ –≤ —Å–µ—Ä–≤–∏—Å–µ –ø—Ä–æ–¥–∞–∂–∏ –±–∏–ª–µ—Ç–æ–≤
        basket.order_cancel()

        # –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ –¥–ª—è –≤—ã–≤–æ–¥–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏–ª–∏ –≤ –ª–æ–≥-—Ñ–∞–π–ª–µ
        messages = [
            {'level': 'error', 'message': '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–ø–ª–∞—Ç—ã –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞. üôÅ'},
            {'level': 'error', 'message': '{code} {message}'.format(
                code=payment_status['code'],
                message=payment_status['message']
            )},
            {'level': 'info',  'message': 'üëâ <a href="{event_url}">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–∫–∞–∑–∞—Ç—å –±–∏–ª–µ—Ç—ã –µ—â—ë —Ä–∞–∑</a>.'.format(
                event_url=basket.event_url
            )},
        ]

        for msg in messages:
            result['messages'].append(msg)

        return result
