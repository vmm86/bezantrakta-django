–°–∞–π—Ç—ã –ë–µ–∑–∞–Ω—Ç—Ä–∞–∫—Ç–∞ –Ω–∞ –±–∞–∑–µ Django
================================

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
-----------------

–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ *docstrings* –∏ –≤ –ø–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö, –∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ *docstings*, –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ HTML-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö ``*.rst``-—Ñ–∞–π–ª–æ–≤, –Ω–∞—Ö–æ–¥—è—â–∏—Ö—Å—è –≤ –¥–µ—Ä–µ–≤–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É—é—â–∏—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥—É–ª–∏.

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
------------

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞–ø–∏—Å–∞–Ω–∞ —Å –ø–æ–º–æ—â—å—é **Sphinx**:

* –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ - –≤ –ø–∞–ø–∫–µ ``docs_dev``,
* —Å–ø—Ä–∞–≤–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –ø–æ —Ä–∞–±–æ—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ - –≤ –ø–∞–ø–∫–µ ``docs_admin``.

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω—ã—Ö ``*.rst``-—Ñ–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ. –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –∑–∞–π—Ç–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –ø–∞–ø–∫—É (``docs_dev`` –∏–ª–∏ ``docs_admin``) –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤ –Ω–µ–π –≤ –∫–æ–Ω—Å–æ–ª–∏ –∫–æ–º–∞–Ω–¥—É ``make html``.

–¢–µ—Å—Ç–æ–≤–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞, –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è —Å—Ä–µ–¥–∞, production deployment
---------------------------------------------------------------

–í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ä–µ–¥—ã –∑–∞ –æ—Å–Ω–æ–≤—É –±–µ—Ä—ë—Ç—Å—è —Ç–æ—Ç –∏–ª–∏ –∏–Ω–æ–π —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –ø–∞–∫–µ—Ç–µ ``project.settings``. –ï–≥–æ –Ω—É–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 3 —É—Ä–æ–≤–Ω—è –≤—ã—à–µ –ø–∞–∫–µ—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫, –ø–µ—Ä–∏–º–µ–Ω–æ–≤–∞—Ç—å –≤ ``settings.py`` –∏ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.

–î–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ–π –º–∞–∂–æ—Ä–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ *–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ* –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, ``belcanto_bezantrakta_django_3``) –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ``venv_v3``).

–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–º–æ–π –ø–∞–ø–∫–∏ —Å —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ``bezantrakta_latest``) –ø—Ä–∏ —ç—Ç–æ–º *–¥–æ–ª–∂–Ω–æ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º*, —Ç.–∫. –≤ ``cron`` –≤—Ä–µ–º—è –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∑–∞–¥–∞–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–º –ø–æ–ª–Ω–æ–≥–æ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞.

1. –¢–µ—Å—Ç–æ–≤—ã–π **development**-–ø—Ä–æ–µ–∫—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - –Ω–∞ –æ—Å–Ω–æ–≤–µ :download:`settings_01_development.py </project/settings/settings_01_development.py>`. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ª–∏–±–æ —Å –ø–æ–º–æ—â—å—é –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤ Django –º–∏–Ω–∏-–≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É ``8000``, –ª–∏–±–æ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–µ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–¥–µ–Ω—Ç–∏—á–Ω—ã **production**, –Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –¥–µ–±–∞–≥–≥–∏–Ω–≥–∞). –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∏–Ω–∏-–≤–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ù–ï —Å–æ–±–∏—Ä–∞—Ç—å —Å—Ç–∞—Ç–∏–∫—É –ø—Ä–∏ –ª—é–±–æ–º –µ—ë –∏–∑–º–µ–Ω–µ–Ω–∏–∏ - –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

2. –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π **staging**-–ø—Ä–æ–µ–∫—Ç (*–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ*) - –Ω–∞ –æ—Å–Ω–æ–≤–µ :download:`settings_02_staging.py </project/settings/settings_02_staging.py>`. –ü—Ä–æ–µ–∫—Ç —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–µ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–¥–µ–Ω—Ç–∏—á–Ω—ã **production**) –∏ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ—Ä–≤–∞—Ç—å—Å—è –∫–∞–∫ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è —Å—Ä–µ–¥–∞ –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–∞.

3. **Production**-–ø—Ä–æ–µ–∫—Ç - –Ω–∞ –æ—Å–Ω–æ–≤–µ :download:`settings_03_production.py </project/settings/settings_03_production.py>`. –ü—Ä–æ–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –±–∞–∑–µ ``nginx`` –∫–∞–∫ –ø—Ä–æ–∫—Å–∏—Ä—É—é—â–µ–≥–æ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –∏ ``uwsgi`` –∫–∞–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ —Å –º–æ–¥—É–ª–µ–º ``wsgi`` –≤ –ø–∞–∫–µ—Ç–µ ``project``.

–¢–µ—Å—Ç–æ–≤–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
-------------------

–ü–æ—Å–ª–µ –ª—é–±–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è ``*.py``-—Ñ–∞–π–ª–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ:

.. code-block:: bash

    service uwsgi restart

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª—é–±–æ–π –º–æ–¥–µ–ª–∏:

.. code-block:: bash

    [ venv ] python manage.py makemigrations
    [ venv ] python manage.py migrate

–ü–æ—Å–ª–µ –ª—é–±–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–∞—Ö ``static``:

.. code-block:: bash

    [ venv ] python manage.py collectstatic

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫ ``_('some_translation')`` –¥–ª—è —Ñ–∞–π–ª–æ–≤ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏:

.. code-block:: bash

    # –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ –¥–ª—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —Ñ–∞–π–ª–∞—Ö –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ –ø–∞–ø–∫–∞—Ö ``locale/ru/LC_MESSAGES/django.po``
    [ venv ] python manage.py makemessages
    # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –¥–ª—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –±–∏–Ω–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤
    [ venv ] python manage.py compilemessages

Production deployment - –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
------------------------------------------------------------

* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (``Debian 9``) –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ.

* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –û–°.

.. code-block:: bash

    sudo su || su
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä—É—Å—Å–∫–æ–π –ª–æ–∫–∞–ª–∏
    dpkg-reconfigure locales
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –≤ ``UTC``
    dpkg-reconfigure tzdata

* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ - ``Python 3``, ``PHP`` –¥–ª—è ``phpMyAdmin``, ``MySQL`` –∏–ª–∏ ``MariaDB``, ``nginx``, ``uWSGI``, ``SVN`` –∏–ª–∏ ``Git``. –ï—Å–ª–∏ ``PHP`` –≤—ã—Ç—è–Ω–µ—Ç –∑–∞ —Å–æ–±–æ–π ``Apache``, –µ–≥–æ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞—Ç–µ–º —É–¥–∞–ª–∏—Ç—å –∑–∞ –Ω–µ–Ω–∞–¥–æ–±–Ω–æ—Å—Ç—å—é.

.. code-block:: bash

    sudo su || su
    apt-get install g++ gcc build-essential automake autoconf gettext
    apt-get install python3 python3-pip python-virtualenv virtualenv python-pkg-resources python3-virtualenv python3-dev libpython3-dev python-imaging libjpeg-dev python3-lxml python3-dev libffi-dev
    apt-get install php php-mbstring php-mysqli zip unzip
    # –ò–õ–ò MySQL, –ò–õ–ò MariaDB
    apt-get install (mysql-server libmysqlclient-dev) || (mariadb-server libmariadbclient-dev)
    apt-get install nginx
    apt-get install uwsgi uwsgi-plugin-python3 uwsgi-plugin-php
    # SVN
    apt-get install subversion

* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ë–î (–Ω–∞ –ø—Ä–∏–º–µ—Ä–µ ``MariaDB``).

.. code-block:: mysql

    nano "/etc/mysql/mariadb.conf.d/50-server"

.. code-block:: ini

    [mysqld]
    init_connect='SET collation_connection = utf8_general_ci'
    init_connect='SET NAMES utf8'
    character-set-server=utf8
    collation-server=utf8_general_ci

.. code-block:: mysql

    mysql

    CREATE USER 'belcanto'@'localhost' IDENTIFIED BY '************';
    CREATE DATABASE belcanto_bezantrakta_django CHARACTER SET utf8 COLLATE utf8_general_ci;
    GRANT ALL PRIVILEGES ON belcanto_bezantrakta_django.* TO 'belcanto'@'localhost';

* –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ ``SVN``-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

.. code-block:: bash

    cd /var/www
    mkdir bezantrakta-django
    cd bezantrakta-django
    mkdir media static log
    svn export http://svn.rterm.ru/bezantrakta-django/tags/X.Y bezantrakta_latest

* –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è ``Python 3``, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö Python-–ø–∞–∫–µ—Ç–æ–≤, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ë–î.

.. code-block:: bash

    cd /opt
    mkdir bezantrakta-django

    # –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ virtual environment
    (virtualenv -p /usr/bin/python3 venv || pyvenv venv)
    source venv/bin/activate

    [ venv ] cd trunk
    [ venv ] pip install -r requirements.txt
    # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ë–î —Å –∏–º–µ–Ω–µ–º, —É–∫–∞–∑–∞–Ω–Ω—ã–º –≤ project.settings.base.DATABASES
    [ venv ] python manage.py migrate

* –°–æ–∑–¥–∞–Ω–∏–µ ``uWSGI``-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

.. code-block:: bash

    touch /etc/uwsgi/sites-available/bezantrakta-django.ini

.. code-block:: ini
   :caption: bezantrakta-django.ini
   :name: bezantrakta-django.ini

    [uwsgi]
    project = /var/www/bezantrakta-django/bezantrakta_latest
    chdir = %(project)

    plugin = python3
    pythonpath = %(project)
    virtualenv = /opt/bezantrakta-django/venv
    module = project.wsgi:application

    master = true
    workers = 64

    harakiri = 60
    harakiri-verbose = true

    cheaper-algo = spare
    cheaper = 8
    cheaper-initial = 8
    cheaper-step = 4
    cheaper-idle = 60
    cheaper-overload = 30

    vacuum = true

.. code-block:: bash

    # –°–æ–∑–¥–∞—Ç—å 2 —Å–∏–º–≤–æ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–µ uWSGI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    ln -s /etc/uwsgi/apps-available/bezantrakta-django.ini /etc/uwsgi/apps-available/bezantrakta-django_default.ini
    ln -s /etc/uwsgi/apps-available/bezantrakta-django.ini /etc/uwsgi/apps-available/bezantrakta-django_api.ini

    ln -s /etc/uwsgi/apps-available/bezantrakta-django_default.ini /etc/uwsgi/apps-enabled/
    ln -s /etc/uwsgi/apps-available/bezantrakta-django_api.ini /etc/uwsgi/apps-enabled/

* –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞ ``nginx``, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ —Å —Å–æ–∫–µ—Ç–æ–º ``uWSGI``-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

.. code-block:: bash

    touch /etc/nginx/sites-available/bezantrakta-django.conf

.. code-block:: nginx
   :caption: bezantrakta-django.conf
   :name: bezantrakta-django.conf

    upstream bezantrakta-django_default {
        server unix:/run/uwsgi/app/bezantrakta-django_default/socket;
    }

    upstream bezantrakta-django_api {
        server unix:/run/uwsgi/app/bezantrakta-django_api/socket;
    }

    server {
        listen 80;
        listen [::]:80;
        root /var/www/bezantrakta-django/bezantrakta_latest;
        server_name bezantrakta.ru *.bezantrakta.ru;

        client_body_buffer_size 10M;
        client_max_body_size    10M;

        access_log /var/log/nginx/bezantrakta-django.access.log;
        error_log  /var/log/nginx/bezantrakta-django.error.log info;

        location /static/ {
            alias /var/www/bezantrakta-django/static/;
            access_log off;
            expires 3600;
        }

        location /media/ {
            alias /var/www/bezantrakta-django/media/;
            access_log off;
            expires 3600;
        }

        location /api/ {
            uwsgi_pass bezantrakta-django_api;
            include uwsgi_params;
            uwsgi_ignore_client_abort on;
        }

        location / {
            uwsgi_pass bezantrakta-django_default;
            include uwsgi_params;
            uwsgi_ignore_client_abort on;
        }
    }

    server {
        listen 80;
        listen [::]:80;
        server_name www.bezantrakta.ru;
        return 301 http://bezantrakta.ru$request_uri;
    }
    #server {
    #    listen 80;
    #    listen [::]:80;
    #    server_name ~^www\.(?<subdomain>\w+)\.bezantrakta.ru$;
    #    return 301 http://$subdomain.bezantrakta.ru$request_uri;
    #}

.. code-block:: bash

    ln -s /etc/nginx/sites-available/bezantrakta-django.conf /etc/nginx/sites-enabled/

* –°–∫–∞—á–∞—Ç—å, —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å ``phpMyAdmin``.

.. code-block:: bash

    cd /var/www
    wget https://files.phpmyadmin.net/phpMyAdmin/X.Y.Z/phpMyAdmin-X.Y.Z-all-languages.zip
    unzip phpMyAdmin-X.Y.Z-all-languages.zip
    rm phpMyAdmin-X.Y.Z-all-languages.zip
    mv phpMyAdmin-X.Y.Z-all-languages pma
    cd pma
    mv config.sample.inc.php config.inc.php
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ config.inc.php

* –°–æ–∑–¥–∞–Ω–∏–µ ``uWSGI``-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è ``phpMyAdmin``.

.. code-block:: bash

    touch /etc/uwsgi/sites-available/pma.ini

.. code-block:: ini
   :caption: pma.ini
   :name: pma.ini

    [uwsgi]
    project = /var/www/pma
    chdir   = %(project)

    plugin      = php
    php-docroot = %(project)
    php-set     = date.timezone=Europe/Moscow
    php-set     = log_errors=1

    master  = true
    workers = 8
    cheaper = 2
    idle    = 30
    vacuum  = 1
    buffer-size = 65535

.. code-block:: bash

    ln -s /etc/uwsgi/apps-available/pma.ini /etc/uwsgi/apps-enabled/

* –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞ ``nginx`` –¥–ª—è ``phpMyAdmin``.

.. code-block:: bash

    touch /etc/nginx/sites-available/pma.conf

.. code-block:: nginx
   :caption: pma.conf
   :name: pma.conf

    server {
        listen 80;
        listen [::]:80;
        server_name pma.bezantrakta.ru;
        root        /var/www/pma;
        access_log  /var/www/pma/log/access.log;
        error_log   /var/www/pma/log/error.log;

        location / {
            index index.php;
            try_files $uri $uri/ /index.php?q=$uri&$args;
        }

        location ~ \.php {
            include uwsgi_params;
            uwsgi_modifier1 14;
            uwsgi_pass unix:/run/uwsgi/app/pma/socket;
        }

        location ~* \.($media_extensions)$ {
            root /var/www/pma;
            access_log off;
            expires 7d;
        }

    }

.. code-block:: bash

    ln -s /etc/nginx/sites-available/pma.conf /etc/nginx/sites-enabled/

* **üëâ** –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ù–ï —É–∫–∞–∑—ã–≤–∞—Ç—å –≤ ``hosts`` –≤—Å–µ –∞–¥—Ä–µ—Å–∞ —Å–∞–π—Ç–æ–≤, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —ç—Ç–æ–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ ``DNS``.

* –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ ``nginx`` –∏ ``uWSGI``, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞.

.. code-block:: bash

    service nginx configtest
    service nginx restart

    service uwsgi restart

* –î–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–æ–¥–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ ``CKEditor`` –Ω—É–∂–Ω–æ —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞ ``ckeditor_plugins/codemirror_1.15.zip`` –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≤ –ø–∞–ø–∫—É ``lib/python3.X/site-packages/ckeditor/static/ckeditor/ckeditor/plugins``, –∏–Ω–∞—á–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. –ï—Å–ª–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞ - –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä ``extraPlugins``.

Production deployment - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–Ω–µ–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
-------------------------------------------------------------

–ü–æ–¥ ``X.Y`` –ø–æ–Ω–∏–º–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

* –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ ``SVN``-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

.. code-block:: bash

    cd /var/www/bezantrakta-django
    svn export http://svn.rterm.ru/bezantrakta-django/tags/X.Y X.Y
    chown -R www-data:www-data X.Y

* –ó–∞–º–µ–Ω–∞ –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ —Å—Ç–∞—Ä–æ–π –Ω–∞ –Ω–æ–≤—É—é, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ ``nginx`` –∏ ``uWSGI``.

.. code-block:: bash

    mv bezantrakta_latest bezantrakta_old && mv X.Y bezantrakta_latest && service nginx restart && service uwsgi restart

* –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞. –í —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞ —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –≤ ``bezantrakta_old`` –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å.

.. code-block:: bash

    rm -rf bezantrakta_old
